(()=>{const e="ezproxy-banner",t="ezproxy-secondary-banner",n="ezproxy-dismissed-domains",o="ezproxy-auto-redirect";let r=!1,s=[];const i=window.matchMedia("(prefers-reduced-motion: reduce)").matches;let a=null;async function c(){if(a)return a;try{const e=await chrome.runtime.sendMessage({type:"GET_CONFIG"});if(e&&e.config)return a=e.config,a;throw new Error("Invalid configuration received")}catch(e){return{institutionName:"Institution",accessIndicators:["access provided by","authenticated via","logged in as"],bannerMessage:"This resource is available through your institution. Access the full content via EZProxy."}}}async function l(){try{const e=chrome.runtime.getURL("domain-list.json"),t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch domain list: ${t.status} ${t.statusText}`);const n=t.headers.get("content-type");!n||n.includes("application/json");const o=await t.json();let r=[];return Array.isArray(o)?(r=o,s=[]):o&&Array.isArray(o.domains)&&(r=o.domains,s=Array.isArray(o.exceptions)?o.exceptions:[]),r}catch(e){try{const e=(await chrome.storage.local.get("ezproxy-domain-list-backup"))["ezproxy-domain-list-backup"];return s=[],Array.isArray(e)?e:[]}catch(e){return s=[],[]}}}async function d(e){if(!e)return!1;const t=window.location.hostname.toLowerCase();if(t.includes("nature.com")||t.includes("chronicle.com"))return!1;let n="";try{var o,r;if(n=(null===(o=document.body)||void 0===o?void 0:o.textContent)||(null===(r=document.documentElement)||void 0===r?void 0:r.textContent)||"",!n||n.length<100){const e=["main","article",".content",".article","#content","#main",'[role="main"]','[role="article"]',".page-content"];for(const t of e){const e=document.querySelectorAll(t);if(e&&e.length>0)for(const t of e)n+=" "+(t.textContent||"")}}if(!n||n.length<100){const e=document.querySelectorAll("p");if(e&&e.length>0)for(const t of e)n+=" "+(t.textContent||"")}n=n.trim()}catch(e){}const s=(e.institutionName||"Institution").toLowerCase(),i=(e.institutionDomain||"example.edu").toLowerCase(),a=(e.institutionShortName||"").toLowerCase(),c=(e.institutionLibraryName||"").toLowerCase();if(t.includes("ft.com")){if(!n||n.length<1e3){const t=parseInt(sessionStorage.getItem("ft-check-count")||"0");if(t<3)return sessionStorage.setItem("ft-check-count",(t+1).toString()),setTimeout((()=>{d(e)}),1500),!1;sessionStorage.removeItem("ft-check-count")}else sessionStorage.removeItem("ft-check-count");const t=[{selector:".o-header__top-link--subscribe",negative:!0,description:"Subscribe button"},{selector:".o-header__top-button--primary",negative:!0,description:"Sign In button"},{selector:".o-banner__outer",negative:!0,description:"Subscription banner"},{selector:".n-messaging-banner",negative:!0,description:"Messaging banner"},{selector:".n-messaging-banner__content",negative:!0,description:"Messaging banner content"},{selector:".o-message",negative:!0,description:"Message component"},{selector:".o-message__content-main",negative:!0,description:"Message content"},{selector:".o-message__actions",negative:!0,description:"Message actions"},{selector:".n-myft-ui--follow",negative:!1,description:"MyFT follow button (requires access)"},{selector:".article__content",negative:!1,description:"Full article content"},{selector:".n-content-body",negative:!1,description:"Article body content"},{selector:".article-body",negative:!1,description:"Article body"},{selector:".js-article__content",negative:!1,description:"JS article content"},{selector:".js-article-body",negative:!1,description:"JS article body"},{selector:".article__content-body",negative:!1,description:"Article content body"}];let o=!1,r=!1;for(const e of t){const t=document.querySelectorAll(e.selector);t&&t.length>0&&(e.negative?r=!0:o=!0)}if(["subscribe to read","to continue reading","premium content","subscribe to the ft","subscribe to continue reading","start your trial","free trial","sign up to","sign in to","subscription required","please subscribe","for unlimited access","to unlock this article","to access this article","already a subscriber? sign in","already a subscriber? log in"].some((e=>!!n.toLowerCase().includes(e)))&&(r=!0),o&&!r)return!0}const l=["access provided by","authenticated via","logged in as","institutional access","institution=",`institution=${s}`,`institution=${i}`,s,i,a,"you have full access","full access available","access to full text"];s&&l.push(`site license access provided by ${s}`),c?l.push(c):s&&l.push(`${s} libraries`),Array.isArray(e.accessIndicators)&&l.push(...e.accessIndicators.map((e=>e.toLowerCase()))),Array.isArray(e.fullAccessIndicators)&&l.push(...e.fullAccessIndicators.map((e=>e.toLowerCase())));const u=n.toLowerCase(),m=[];if(l.some((e=>{if(!e)return!1;return!!u.includes(e.toLowerCase())&&(m.push(e),!0)})),m.length>0)return!0;if([...Array.from(document.querySelectorAll('a[href*="ezproxy" i]')),...Array.from(document.querySelectorAll('a[href*="proxy" i]')),...Array.from(document.querySelectorAll("*")).filter((e=>{var t;const n=(null===(t=e.textContent)||void 0===t?void 0:t.toLowerCase())||"";return n.includes("ezproxy")||n.includes("proxy login")||n.includes("institutional login")}))].length>0)return!0;["access denied","login required","sign in","log in","authentication required","institutional access required"].some((e=>u.includes(e)));return!1}async function u(e){try{const t=(await chrome.storage.local.get(n))[n]||[];return t.some((t=>e.endsWith(t)||e===t))}catch(e){return!1}}function m(e){(parseInt(getComputedStyle(document.body).marginTop)||0)<e&&(document.body.style.marginTop=e+"px")}function p(){document.getElementById(e)||(document.body.style.marginTop="")}async function y(t,o,r){const s=(await c()).banner||{},a=document.getElementById(e);a&&a.remove();const l=document.createElement("div");l.id=e,l.setAttribute("role","banner"),l.setAttribute("aria-label","EZProxy access notification");const d=`\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background-color: ${s.backgroundColor||"#f8f9fa"};\n        color: ${s.textColor||"#495057"};\n        border-bottom: 1px solid ${s.borderColor||"#dee2e6"};\n        padding: ${s.padding||"12px 20px"};\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        z-index: ${s.zIndex||"2147483647"};\n        font-family: ${s.fontFamily||'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'};\n        box-shadow: ${s.boxShadow||"0 2px 4px rgba(0,0,0,0.1)"};\n        font-size: ${s.fontSize||"14px"};\n        line-height: ${s.lineHeight||"1.5"};\n    `,u=i?"":`\n        transform: translateY(-100%);\n        transition: transform ${s.animationDuration||"0.3s"} ease-out;\n    `,p=`\n        @media (max-width: ${s.mobileBreakpoint||"768px"}) {\n            flex-direction: column;\n            gap: 10px;\n            padding: 15px !important;\n            text-align: center;\n        }\n    `;if(l.style.cssText=d+u,!document.getElementById("ezproxy-banner-styles")){const t=document.createElement("style");t.id="ezproxy-banner-styles",t.textContent=`\n            #${e} ${p}\n            #${e} .banner-buttons {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n            }\n            @media (max-width: 768px) {\n                #${e} .banner-buttons {\n                    justify-content: center;\n                    width: 100%;\n                }\n                #${e} .banner-message {\n                    margin-bottom: 5px;\n                }\n            }\n        `,document.head.appendChild(t)}const y=document.createElement("div");y.className="banner-message",y.textContent=t,y.style.cssText=`\n        color: ${s.textColor||"#495057"};\n        flex: 1;\n        margin-right: 15px;\n    `;const g=document.createElement("div");g.className="banner-buttons";const h=s.button||{},b=s.dismissButton||{},x=s.closeButton||{},v=document.createElement("button");if("true"===sessionStorage.getItem("ezproxy-exception-domain")){const e=sessionStorage.getItem("ezproxy-exception-button-text")||"How to Access",t=sessionStorage.getItem("ezproxy-exception-button-aria")||"Learn how to access this resource through your library";v.textContent=e,v.setAttribute("aria-label",t),sessionStorage.removeItem("ezproxy-exception-domain"),sessionStorage.removeItem("ezproxy-exception-button-text"),sessionStorage.removeItem("ezproxy-exception-button-aria")}else v.textContent=h.text||"Access via EZProxy",v.setAttribute("aria-label","Access this resource via EZProxy");v.style.cssText=`\n        background-color: ${h.backgroundColor||"#0d6efd"};\n        color: ${h.textColor||"#ffffff"};\n        border: none;\n        padding: ${h.padding||"8px 16px"};\n        border-radius: ${h.borderRadius||"4px"};\n        cursor: pointer;\n        font-size: ${s.fontSize||"14px"};\n        font-weight: 500;\n        transition: all 0.2s ease;\n    `,v.addEventListener("mouseenter",(()=>{v.style.backgroundColor=h.hoverColor||"#0b5ed7",v.style.transform="translateY(-1px)"})),v.addEventListener("mouseleave",(()=>{v.style.backgroundColor=h.backgroundColor||"#0d6efd",v.style.transform=""})),v.addEventListener("focus",(()=>{v.style.outline=`2px solid ${h.hoverColor||"#0b5ed7"}`,v.style.outlineOffset="2px"})),v.addEventListener("blur",(()=>{v.style.outline="",v.style.outlineOffset=""})),v.addEventListener("click",(()=>{window.location.href=o}));const w=document.createElement("button");w.textContent=b.text||"Dismiss",w.setAttribute("aria-label","Dismiss this notification"),w.style.cssText=`\n        background-color: ${b.backgroundColor||"transparent"};\n        color: ${b.textColor||"#6c757d"};\n        border: 1px solid ${s.borderColor||"#dee2e6"};\n        padding: ${b.padding||"6px 12px"};\n        border-radius: ${b.borderRadius||"4px"};\n        margin-right: 10px;\n        cursor: pointer;\n        font-size: ${s.fontSize||"14px"};\n        transition: all 0.2s ease;\n    `,w.addEventListener("mouseenter",(()=>{w.style.backgroundColor=b.hoverColor||"#e9ecef",w.style.borderColor=s.borderColor||"#ced4da",w.style.transform="translateY(-1px)"})),w.addEventListener("mouseleave",(()=>{w.style.backgroundColor=b.backgroundColor||"transparent",w.style.borderColor=s.borderColor||"#dee2e6",w.style.transform=""})),w.addEventListener("focus",(()=>{w.style.outline=`2px solid ${b.hoverColor||"#6c757d"}`,w.style.outlineOffset="2px"})),w.addEventListener("blur",(()=>{w.style.outline="",w.style.outlineOffset=""})),w.addEventListener("click",(async()=>{await async function(e){try{const o=(await chrome.storage.local.get(n))[n]||[];o.find((t=>e===t||e.endsWith("."+t)))||(o.push(e),await chrome.storage.local.set({[n]:o}));try{let n;if(chrome.tabs&&chrome.tabs.query)try{var t;const e=await chrome.tabs.query({active:!0,currentWindow:!0});e&&null!==(t=e[0])&&void 0!==t&&t.id&&(n=e[0].id)}catch(e){}if(n){if(await chrome.runtime.sendMessage({action:"updateIcon",tabId:n,isDismissed:!0}),chrome.action&&chrome.action.setBadgeText)try{await chrome.action.setBadgeText({tabId:n,text:"X"}),await chrome.action.setBadgeBackgroundColor({tabId:n,color:"#dc3545"})}catch(e){}}else await chrome.runtime.sendMessage({action:"dismissDomain",domain:e})}catch(e){}return!0}catch(e){return!1}}(r),f()}));const C=document.createElement("button");C.textContent=x.text||"×",C.setAttribute("aria-label","Close this notification"),C.style.cssText=`\n        background: transparent;\n        border: none;\n        font-size: 20px;\n        font-weight: bold;\n        color: ${x.color||"#6c757d"};\n        cursor: pointer;\n        padding: 0 0 0 10px;\n        line-height: 1;\n        width: 24px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: all 0.2s ease;\n    `,C.addEventListener("mouseenter",(()=>{C.style.backgroundColor=x.hoverColor||"#e9ecef",C.style.color=x.hoverColor||"#212529",C.style.transform="scale(1.1)"})),C.addEventListener("mouseleave",(()=>{C.style.backgroundColor="transparent",C.style.color=x.color||"#6c757d",C.style.transform=""})),C.addEventListener("focus",(()=>{C.style.outline=`2px solid ${x.hoverColor||"#6c757d"}`,C.style.outlineOffset="2px"})),C.addEventListener("blur",(()=>{C.style.outline="",C.style.outlineOffset=""})),C.addEventListener("click",f),l.addEventListener("keydown",(e=>{"Escape"===e.key&&f()})),g.appendChild(v),g.appendChild(w),g.appendChild(C),l.appendChild(y),l.appendChild(g),document.body.insertBefore(l,document.body.firstChild),i||(l.offsetHeight,l.style.transform="translateY(0)");m(l.offsetHeight),setTimeout((()=>{v.focus()}),i?0:100)}async function f(){const t=document.getElementById(e);if(!t)return;const n=(await c()).banner||{};window.matchMedia("(prefers-reduced-motion: reduce)").matches?(t.remove(),p()):(t.style.transition=`transform ${n.animationDuration||"0.3s"} ease-out`,t.style.transform="translateY(-100%)",await new Promise((e=>{t.addEventListener("transitionend",(()=>e()),{once:!0}),setTimeout(e,n.animationDuration?1e3*parseFloat(n.animationDuration):300)})),t.remove(),p()),document.activeElement&&document.activeElement.closest(`#${e}`)&&document.activeElement.blur()}function g(e){const t=(e=e.split(":")[0]).split(".");return t.length<=2?e:t.slice(-2).join(".")}async function h(){const e=document.getElementById(t);if(!e)return;const n=(await c()).banner||{};window.matchMedia("(prefers-reduced-motion: reduce)").matches?(e.remove(),p()):(e.style.transition=`transform ${n.animationDuration||"0.3s"} ease-out`,e.style.transform="translateY(-100%)",await new Promise((t=>{e.addEventListener("transitionend",(()=>t()),{once:!0}),setTimeout(t,n.animationDuration?1e3*parseFloat(n.animationDuration):300)})),e.remove(),p()),document.activeElement&&document.activeElement.closest(`#${t}`)&&document.activeElement.blur()}async function b(){if(!r){try{const[e]=await Promise.all([c(),l().catch((()=>[]))]),n=function(e){const t=window.location.hostname;if(!e.ezproxyBaseUrl||!t.includes(e.ezproxyBaseUrl))return null;const n=String(e.ezproxyBaseUrl).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp("^([^.]+)\\."+n),r=t.match(o);if(!r)return null;const i=r[1].replace(/-/g,".");if(Array.isArray(s)){const e=s.find((e=>i.includes(e)||i===e));if(e)return{originalDomain:i,exceptionDomain:e}}return null}(e);if(n){const o=e.libraryHelpUrl||"https://library.example.edu/ask",r=g(n.originalDomain),s=`${o}${o.includes("?")?"&":"?"}q=${r}`,a=e.secondaryHelpButtonText||"Info for this site";await async function(e,n,o){const r=(await c()).banner||{},s=document.getElementById(t);s&&s.remove();const a=document.createElement("div");a.id=t,a.setAttribute("role","banner"),a.setAttribute("aria-label","Library help information");const l=`\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background-color: #e8f4f8;\n        color: #155e75;\n        border-bottom: 1px solid #0891b2;\n        padding: ${r.padding||"12px 20px"};\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        z-index: ${r.zIndex||"2147483647"};\n        font-family: ${r.fontFamily||'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'};\n        box-shadow: ${r.boxShadow||"0 2px 4px rgba(0,0,0,0.1)"};\n        font-size: ${r.fontSize||"14px"};\n        line-height: ${r.lineHeight||"1.5"};\n    `,d=i?"":`\n        transform: translateY(-100%);\n        transition: transform ${r.animationDuration||"0.3s"} ease-out;\n    `;a.style.cssText=l+d;const u=document.createElement("div");u.className="banner-message",u.textContent="This site may require additional steps.  Please see the 'Info for this site' button.",u.style.cssText="\n        color: #155e75;\n        flex: 1;\n        margin-right: 15px;\n    ";const p=document.createElement("div");p.className="banner-buttons",p.style.cssText="\n        display: flex;\n        gap: 10px;\n        align-items: center;\n    ";const y=document.createElement("button");y.textContent=o,y.setAttribute("aria-label",`Get help information for ${e}`),y.style.cssText=`\n        background-color: #0891b2;\n        color: #ffffff;\n        border: none;\n        padding: 8px 16px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: ${r.fontSize||"14px"};\n        font-weight: 500;\n        transition: all 0.2s ease;\n    `,y.addEventListener("mouseenter",(()=>{y.style.backgroundColor="#0e7490",y.style.transform="translateY(-1px)"})),y.addEventListener("mouseleave",(()=>{y.style.backgroundColor="#0891b2",y.style.transform=""})),y.addEventListener("focus",(()=>{y.style.outline="2px solid #0e7490",y.style.outlineOffset="2px"})),y.addEventListener("blur",(()=>{y.style.outline="",y.style.outlineOffset=""})),y.addEventListener("click",(()=>{window.open(n,"_blank")}));const f=document.createElement("button");f.textContent="×",f.setAttribute("aria-label","Close this notification"),f.style.cssText="\n        background: transparent;\n        border: none;\n        font-size: 20px;\n        font-weight: bold;\n        color: #155e75;\n        cursor: pointer;\n        padding: 0 0 0 10px;\n        line-height: 1;\n        width: 24px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: all 0.2s ease;\n    ",f.addEventListener("mouseenter",(()=>{f.style.backgroundColor="#cffafe",f.style.transform="scale(1.1)"})),f.addEventListener("mouseleave",(()=>{f.style.backgroundColor="transparent",f.style.transform=""})),f.addEventListener("focus",(()=>{f.style.outline="2px solid #0e7490",f.style.outlineOffset="2px"})),f.addEventListener("blur",(()=>{f.style.outline="",f.style.outlineOffset=""})),f.addEventListener("click",h),a.addEventListener("keydown",(e=>{"Escape"===e.key&&h()})),p.appendChild(y),p.appendChild(f),a.appendChild(u),a.appendChild(p),document.body.insertBefore(a,document.body.firstChild),i||(a.offsetHeight,a.style.transform="translateY(0)"),m(a.offsetHeight),setTimeout((()=>{y.focus()}),i?0:100)}(n.originalDomain,s,a)}}catch(e){}chrome.storage.onChanged.addListener(((t,n)=>{if("local"===n&&t.dismissedDomains){const t=document.getElementById(e);t&&(t.remove(),p());!async function(e){if(!e||"string"!=typeof e)return;try{const t=await c().catch((e=>{throw new Error("Failed to load extension configuration")}));if(!t)return;const n=await l().catch((e=>{throw new Error("Failed to load domain list")}));let o;try{const t=new URL(e);if(o=t.hostname,/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(o))return}catch(e){return}const r=n.find((e=>{const t=o===e,n=o.endsWith("."+e);return t||n}));if(!r){try{const[e]=await chrome.runtime.sendMessage({action:"getTab"});null!=e&&e.id&&await chrome.runtime.sendMessage({action:"updateIcon",tabId:e.id,isDismissed:!1})}catch(e){}return}if(await u(r).catch((e=>!1))){try{const[e]=await chrome.runtime.sendMessage({action:"getTab"});null!=e&&e.id&&await chrome.runtime.sendMessage({action:"updateIcon",tabId:e.id,isDismissed:!0})}catch(e){}return}try{if(d(t))return}catch(e){}if(await u(r).catch((()=>!1)))return;if(!t.ezproxyBaseUrl)return;let i=t.ezproxyBaseUrl.trim();i.endsWith("/")||(i=`${i}/`);let a=e;const m=a.match(/^https?:\/\/(.*)/i);m&&(a=m[1]);const p=s.find((e=>r.includes(e)||r===e));let f,h,b,x;if(!!p){const e=t.libraryHelpUrl||"https://library.example.edu/ask",n=g(r);f=`${e}${e.includes("?")?"&":"?"}q=${n}`,h=`${p} requires special access and cannot be accessed via standard EZProxy. Please visit your library's help page for assistance.`,b="How to Access",x="Learn how to access this resource through your library",sessionStorage.setItem("ezproxy-exception-domain","true"),sessionStorage.setItem("ezproxy-exception-button-text",b),sessionStorage.setItem("ezproxy-exception-button-aria",x)}else f=`${i}${a}`,h=`This resource is available through ${t.institutionName||"your library"}. Access the full content via EZProxy.`;try{await y(h,f,r)}catch(e){throw e}}catch(e){try{const t=document.createElement("div");t.style.position="fixed",t.style.top="10px",t.style.right="10px",t.style.padding="10px",t.style.backgroundColor="#ffebee",t.style.border="1px solid #ef9a9a",t.style.borderRadius="4px",t.style.zIndex="100000",t.style.maxWidth="300px",t.style.fontFamily="Arial, sans-serif",t.style.fontSize="14px";const n=document.createElement("div");n.style.fontWeight="bold",n.style.marginBottom="5px",n.textContent="EZProxy Extension Error";const o=document.createElement("div");o.textContent=e.message||"An unknown error occurred";const r=document.createElement("div");r.style.marginTop="5px",r.style.fontSize="12px",r.style.color="#666",r.textContent="Check console for details",t.appendChild(n),t.appendChild(o),t.appendChild(r),document.body.appendChild(t),setTimeout((()=>{document.body.contains(t)&&t.remove()}),1e4)}catch(e){}}}(window.location.href)}})),r=!0}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",b):b(),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("DOMAIN_MATCH"===e.type)return n({received:!0}),c().then((t=>{const n=t;return u(e.domain).then((e=>{if(e)throw new Error("DOMAIN_DISMISSED");return n}))})).then((e=>d(e).then((t=>{if(t)throw new Error("HAS_INSTITUTIONAL_ACCESS");return e})).catch((t=>{if("HAS_INSTITUTIONAL_ACCESS"===t.message)throw t;return e})))).then((t=>async function(){try{return!0===(await chrome.storage.local.get(o))[o]}catch(e){return!1}}().then((n=>{if(n)throw window.location.href=e.ezproxyUrl,new Error("AUTO_REDIRECTED");return t})))).then((t=>{y(e.bannerMessage||`This resource is available through ${t.institutionLibraryName||"your library"}. Access the full content via EZProxy.`,e.ezproxyUrl,e.domain)})).catch((e=>{["DOMAIN_DISMISSED","HAS_INSTITUTIONAL_ACCESS","AUTO_REDIRECTED"].includes(e.message)})),!0}))})();
//# sourceMappingURL=content.js.map