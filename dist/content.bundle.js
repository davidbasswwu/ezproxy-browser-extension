const e="ezproxy-banner",n="ezproxy-secondary-banner",t="ezproxy-dismissed-domains",o="ezproxy-auto-redirect";let s=!1;const i=window.matchMedia("(prefers-reduced-motion: reduce)").matches;let r=null;async function a(){if(r)return r;try{const e=await chrome.runtime.sendMessage({type:"GET_CONFIG"});if(e&&e.config)return r=e.config,r;throw new Error("Invalid configuration received")}catch(e){return console.error("Failed to load configuration:",e),{institutionName:"Institution",accessIndicators:["access provided by","authenticated via","logged in as"],bannerMessage:"This resource is available through your institution. Access the full content via EZProxy."}}}async function c(e){if(console.log("[hasInstitutionalAccess] Checking if user has institutional access"),!e)return console.warn("[hasInstitutionalAccess] No config provided"),!1;const n=window.location.hostname.toLowerCase();if(n.includes("nature.com")||n.includes("chronicle.com"))return console.log(`[hasInstitutionalAccess] Special case for ${n}: forcing banner display`),!1;let t="";try{var o,s;if(t=(null===(o=document.body)||void 0===o?void 0:o.textContent)||(null===(s=document.documentElement)||void 0===s?void 0:s.textContent)||"",!t||t.length<100){console.log("[hasInstitutionalAccess] Direct text extraction yielded limited content, trying content areas");const e=["main","article",".content",".article","#content","#main",'[role="main"]','[role="article"]',".page-content"];for(const n of e){const e=document.querySelectorAll(n);if(e&&e.length>0)for(const n of e)t+=" "+(n.textContent||"")}}if(!t||t.length<100){console.log("[hasInstitutionalAccess] Content area extraction yielded limited content, trying paragraphs");const e=document.querySelectorAll("p");if(e&&e.length>0)for(const n of e)t+=" "+(n.textContent||"")}t=t.trim()}catch(e){console.error("[hasInstitutionalAccess] Error extracting page text:",e)}t||console.warn("[hasInstitutionalAccess] Could not get page text after multiple extraction attempts");const i=(e.institutionName||"Institution").toLowerCase(),r=(e.institutionDomain||"example.edu").toLowerCase(),a=(e.institutionShortName||"").toLowerCase(),l=(e.institutionLibraryName||"").toLowerCase();if(console.log("[hasInstitutionalAccess] Using institution:",i,"domain:",r),n.includes("ft.com")){console.log("[hasInstitutionalAccess] Financial Times website detected, performing detailed check");if(!t||t.length<1e3){console.log("[hasInstitutionalAccess] FT content may not be fully loaded, adding delay checks");const n=parseInt(sessionStorage.getItem("ft-check-count")||"0");if(n<3)return sessionStorage.setItem("ft-check-count",(n+1).toString()),setTimeout((()=>{console.log(`[hasInstitutionalAccess] Retrying FT check (attempt ${n+1}/3)`),c(e)}),1500),!1;sessionStorage.removeItem("ft-check-count"),console.log("[hasInstitutionalAccess] Maximum FT check attempts reached, proceeding with current content")}else sessionStorage.removeItem("ft-check-count");const n=[{selector:".o-header__top-link--subscribe",negative:!0,description:"Subscribe button"},{selector:".o-header__top-button--primary",negative:!0,description:"Sign In button"},{selector:".o-banner__outer",negative:!0,description:"Subscription banner"},{selector:".n-messaging-banner",negative:!0,description:"Messaging banner"},{selector:".n-messaging-banner__content",negative:!0,description:"Messaging banner content"},{selector:".o-message",negative:!0,description:"Message component"},{selector:".o-message__content-main",negative:!0,description:"Message content"},{selector:".o-message__actions",negative:!0,description:"Message actions"},{selector:".n-myft-ui--follow",negative:!1,description:"MyFT follow button (requires access)"},{selector:".article__content",negative:!1,description:"Full article content"},{selector:".n-content-body",negative:!1,description:"Article body content"},{selector:".article-body",negative:!1,description:"Article body"},{selector:".js-article__content",negative:!1,description:"JS article content"},{selector:".js-article-body",negative:!1,description:"JS article body"},{selector:".article__content-body",negative:!1,description:"Article content body"}];let o=!1,s=!1;for(const e of n){const n=document.querySelectorAll(e.selector);n&&n.length>0&&(console.log(`[hasInstitutionalAccess] Found FT ${e.description}: ${n.length} elements`),e.negative?s=!0:o=!0)}if(["subscribe to read","to continue reading","premium content","subscribe to the ft","subscribe to continue reading","start your trial","free trial","sign up to","sign in to","subscription required","please subscribe","for unlimited access","to unlock this article","to access this article","already a subscriber? sign in","already a subscriber? log in"].some((e=>!!t.toLowerCase().includes(e)&&(console.log(`[hasInstitutionalAccess] Found FT paywall text: "${e}"`),!0)))&&(console.log("[hasInstitutionalAccess] Detected paywall content on FT"),s=!0),o&&!s)return console.log("[hasInstitutionalAccess] Detected institutional access on FT based on page elements"),!0}const d=["access provided by","authenticated via","logged in as","institutional access","institution=",`institution=${i}`,`institution=${r}`,i,r,a,"you have full access","full access available","access to full text"];i&&d.push(`site license access provided by ${i}`),l?d.push(l):i&&d.push(`${i} libraries`),Array.isArray(e.accessIndicators)&&d.push(...e.accessIndicators.map((e=>e.toLowerCase()))),Array.isArray(e.fullAccessIndicators)&&d.push(...e.fullAccessIndicators.map((e=>e.toLowerCase()))),console.log("[hasInstitutionalAccess] Checking page for indicators:",d);const u=t.toLowerCase();console.log("[hasInstitutionalAccess] Page text sample (first 500 chars):",u.substring(0,500).replace(/\s+/g," ").trim()+"...");const m=[];d.some((e=>{if(!e)return!1;return!!u.includes(e.toLowerCase())&&(m.push(e),!0)}));if(m.length>0)return console.log("[hasInstitutionalAccess] Found access indicators:",m),!0;const g=[...Array.from(document.querySelectorAll('a[href*="ezproxy" i]')),...Array.from(document.querySelectorAll('a[href*="proxy" i]')),...Array.from(document.querySelectorAll("*")).filter((e=>{var n;const t=(null===(n=e.textContent)||void 0===n?void 0:n.toLowerCase())||"";return t.includes("ezproxy")||t.includes("proxy login")||t.includes("institutional login")}))];if(g.length>0)return console.log(`[hasInstitutionalAccess] Found ${g.length} EZProxy related elements`),!0;return["access denied","login required","sign in","log in","authentication required","institutional access required"].some((e=>u.includes(e)))?(console.log("[hasInstitutionalAccess] Detected access denied/login page"),!1):(console.log("[hasInstitutionalAccess] No institutional access indicators found"),!1)}async function l(e){try{console.log("Checking if domain is dismissed:",e);const n=(await chrome.storage.local.get(t))[t]||[];console.log("Current dismissed domains:",n);const o=n.some((n=>e.endsWith(n)||e===n));return console.log("Domain dismissed status:",o),o}catch(e){return console.error("Error checking dismissed domains:",e),!1}}function d(e){(parseInt(getComputedStyle(document.body).marginTop)||0)<e&&(document.body.style.marginTop=e+"px")}function u(){document.getElementById(e)||(document.body.style.marginTop="")}async function m(n,o,s){const r=(await a()).banner||{},c=document.getElementById(e);c&&c.remove();const l=document.createElement("div");l.id=e,l.setAttribute("role","banner"),l.setAttribute("aria-label","EZProxy access notification");const u=`\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background-color: ${r.backgroundColor||"#f8f9fa"};\n        color: ${r.textColor||"#495057"};\n        border-bottom: 1px solid ${r.borderColor||"#dee2e6"};\n        padding: ${r.padding||"12px 20px"};\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        z-index: ${r.zIndex||"2147483647"};\n        font-family: ${r.fontFamily||'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'};\n        box-shadow: ${r.boxShadow||"0 2px 4px rgba(0,0,0,0.1)"};\n        font-size: ${r.fontSize||"14px"};\n        line-height: ${r.lineHeight||"1.5"};\n    `,m=i?"":`\n        transform: translateY(-100%);\n        transition: transform ${r.animationDuration||"0.3s"} ease-out;\n    `,h=`\n        @media (max-width: ${r.mobileBreakpoint||"768px"}) {\n            flex-direction: column;\n            gap: 10px;\n            padding: 15px !important;\n            text-align: center;\n        }\n    `;if(l.style.cssText=u+m,!document.getElementById("ezproxy-banner-styles")){const n=document.createElement("style");n.id="ezproxy-banner-styles",n.textContent=`\n            #${e} ${h}\n            #${e} .banner-buttons {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n            }\n            @media (max-width: 768px) {\n                #${e} .banner-buttons {\n                    justify-content: center;\n                    width: 100%;\n                }\n                #${e} .banner-message {\n                    margin-bottom: 5px;\n                }\n            }\n        `,document.head.appendChild(n)}const p=document.createElement("div");p.className="banner-message",p.textContent=n,p.style.cssText=`\n        color: ${r.textColor||"#495057"};\n        flex: 1;\n        margin-right: 15px;\n    `;const f=document.createElement("div");f.className="banner-buttons";const y=r.button||{},b=r.dismissButton||{},x=r.closeButton||{},w=document.createElement("button");if("true"===sessionStorage.getItem("ezproxy-exception-domain")){const e=sessionStorage.getItem("ezproxy-exception-button-text")||"How to Access",n=sessionStorage.getItem("ezproxy-exception-button-aria")||"Learn how to access this resource through your library";w.textContent=e,w.setAttribute("aria-label",n),sessionStorage.removeItem("ezproxy-exception-domain"),sessionStorage.removeItem("ezproxy-exception-button-text"),sessionStorage.removeItem("ezproxy-exception-button-aria")}else w.textContent=y.text||"Access via EZProxy",w.setAttribute("aria-label","Access this resource via EZProxy");w.style.cssText=`\n        background-color: ${y.backgroundColor||"#0d6efd"};\n        color: ${y.textColor||"#ffffff"};\n        border: none;\n        padding: ${y.padding||"8px 16px"};\n        border-radius: ${y.borderRadius||"4px"};\n        cursor: pointer;\n        font-size: ${r.fontSize||"14px"};\n        font-weight: 500;\n        transition: all 0.2s ease;\n    `,w.addEventListener("mouseenter",(()=>{w.style.backgroundColor=y.hoverColor||"#0b5ed7",w.style.transform="translateY(-1px)"})),w.addEventListener("mouseleave",(()=>{w.style.backgroundColor=y.backgroundColor||"#0d6efd",w.style.transform=""})),w.addEventListener("focus",(()=>{w.style.outline=`2px solid ${y.hoverColor||"#0b5ed7"}`,w.style.outlineOffset="2px"})),w.addEventListener("blur",(()=>{w.style.outline="",w.style.outlineOffset=""})),w.addEventListener("click",(()=>{window.location.href=o}));const v=document.createElement("button");v.textContent=b.text||"Dismiss",v.setAttribute("aria-label","Dismiss this notification"),v.style.cssText=`\n        background-color: ${b.backgroundColor||"transparent"};\n        color: ${b.textColor||"#6c757d"};\n        border: 1px solid ${r.borderColor||"#dee2e6"};\n        padding: ${b.padding||"6px 12px"};\n        border-radius: ${b.borderRadius||"4px"};\n        margin-right: 10px;\n        cursor: pointer;\n        font-size: ${r.fontSize||"14px"};\n        transition: all 0.2s ease;\n    `,v.addEventListener("mouseenter",(()=>{v.style.backgroundColor=b.hoverColor||"#e9ecef",v.style.borderColor=r.borderColor||"#ced4da",v.style.transform="translateY(-1px)"})),v.addEventListener("mouseleave",(()=>{v.style.backgroundColor=b.backgroundColor||"transparent",v.style.borderColor=r.borderColor||"#dee2e6",v.style.transform=""})),v.addEventListener("focus",(()=>{v.style.outline=`2px solid ${b.hoverColor||"#6c757d"}`,v.style.outlineOffset="2px"})),v.addEventListener("blur",(()=>{v.style.outline="",v.style.outlineOffset=""})),v.addEventListener("click",(async()=>{await async function(e){try{console.log("Dismissing domain:",e);const o=(await chrome.storage.local.get(t))[t]||[],s=o.find((n=>e===n||e.endsWith("."+n)));s?console.log("Domain or parent domain already in dismissed list:",s):(o.push(e),console.log("Saving dismissed domains:",o),await chrome.storage.local.set({[t]:o}));try{let t;if(chrome.tabs&&chrome.tabs.query)try{var n;const e=await chrome.tabs.query({active:!0,currentWindow:!0});e&&null!==(n=e[0])&&void 0!==n&&n.id&&(t=e[0].id)}catch(e){console.warn("Could not get tab ID using chrome.tabs:",e)}if(t){if(console.log("Updating icon for tab:",t),await chrome.runtime.sendMessage({action:"updateIcon",tabId:t,isDismissed:!0}),chrome.action&&chrome.action.setBadgeText)try{await chrome.action.setBadgeText({tabId:t,text:"X"}),await chrome.action.setBadgeBackgroundColor({tabId:t,color:"#dc3545"})}catch(e){console.warn("Could not update badge:",e)}}else console.log("No tab ID available, using background script to update icon"),await chrome.runtime.sendMessage({action:"dismissDomain",domain:e})}catch(e){console.error("Error updating icon:",e)}return!0}catch(e){return console.error("Error saving dismissed domain:",e),!1}}(s),g()}));const A=document.createElement("button");A.innerHTML=x.text||"&times;",A.setAttribute("aria-label","Close this notification"),A.style.cssText=`\n        background: transparent;\n        border: none;\n        font-size: 20px;\n        font-weight: bold;\n        color: ${x.color||"#6c757d"};\n        cursor: pointer;\n        padding: 0 0 0 10px;\n        line-height: 1;\n        width: 24px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: all 0.2s ease;\n    `,A.addEventListener("mouseenter",(()=>{A.style.backgroundColor=x.hoverColor||"#e9ecef",A.style.color=x.hoverColor||"#212529",A.style.transform="scale(1.1)"})),A.addEventListener("mouseleave",(()=>{A.style.backgroundColor="transparent",A.style.color=x.color||"#6c757d",A.style.transform=""})),A.addEventListener("focus",(()=>{A.style.outline=`2px solid ${x.hoverColor||"#6c757d"}`,A.style.outlineOffset="2px"})),A.addEventListener("blur",(()=>{A.style.outline="",A.style.outlineOffset=""})),A.addEventListener("click",g),l.addEventListener("keydown",(e=>{"Escape"===e.key&&g()})),f.appendChild(w),f.appendChild(v),f.appendChild(A),l.appendChild(p),l.appendChild(f),document.body.insertBefore(l,document.body.firstChild),i||(l.offsetHeight,l.style.transform="translateY(0)");d(l.offsetHeight),setTimeout((()=>{w.focus()}),i?0:100)}async function g(){const n=document.getElementById(e);if(!n)return;const t=(await a()).banner||{};window.matchMedia("(prefers-reduced-motion: reduce)").matches?(n.remove(),u()):(n.style.transition=`transform ${t.animationDuration||"0.3s"} ease-out`,n.style.transform="translateY(-100%)",await new Promise((e=>{n.addEventListener("transitionend",(()=>e()),{once:!0}),setTimeout(e,t.animationDuration?1e3*parseFloat(t.animationDuration):300)})),n.remove(),u()),document.activeElement&&document.activeElement.closest(`#${e}`)&&document.activeElement.blur()}function h(e){const n=(e=e.split(":")[0]).split(".");return n.length<=2?e:n.slice(-2).join(".")}async function p(){const e=document.getElementById(n);if(!e)return;const t=(await a()).banner||{};window.matchMedia("(prefers-reduced-motion: reduce)").matches?(e.remove(),u()):(e.style.transition=`transform ${t.animationDuration||"0.3s"} ease-out`,e.style.transform="translateY(-100%)",await new Promise((n=>{e.addEventListener("transitionend",(()=>n()),{once:!0}),setTimeout(n,t.animationDuration?1e3*parseFloat(t.animationDuration):300)})),e.remove(),u()),document.activeElement&&document.activeElement.closest(`#${n}`)&&document.activeElement.blur()}async function f(){if(!s){try{const e=await a(),t=function(e){window.location.href;const n=window.location.hostname;if(!e.ezproxyBaseUrl||!n.includes(e.ezproxyBaseUrl))return null;const t=new RegExp(`^([^.]+)\\.${e.ezproxyBaseUrl.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`),o=n.match(t);if(!o)return null;const s=o[1].replace(/-/g,".");if(e.urlExceptions&&Array.isArray(e.urlExceptions)){const n=e.urlExceptions.find((e=>s.includes(e)||s===e));if(n)return{originalDomain:s,exceptionDomain:n}}return null}(e);if(t){console.log("[init] Detected EZProxy exception URL for domain:",t.originalDomain);const o=e.libraryHelpUrl||"https://library.example.edu/ask",s=h(t.originalDomain),r=`${o}${o.includes("?")?"&":"?"}q=${s}`,c=e.secondaryHelpButtonText||"Info for this site";await async function(e,t,o){const s=(await a()).banner||{},r=document.getElementById(n);r&&r.remove();const c=document.createElement("div");c.id=n,c.setAttribute("role","banner"),c.setAttribute("aria-label","Library help information");const l=`\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background-color: #e8f4f8;\n        color: #155e75;\n        border-bottom: 1px solid #0891b2;\n        padding: ${s.padding||"12px 20px"};\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        z-index: ${s.zIndex||"2147483647"};\n        font-family: ${s.fontFamily||'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'};\n        box-shadow: ${s.boxShadow||"0 2px 4px rgba(0,0,0,0.1)"};\n        font-size: ${s.fontSize||"14px"};\n        line-height: ${s.lineHeight||"1.5"};\n    `,u=i?"":`\n        transform: translateY(-100%);\n        transition: transform ${s.animationDuration||"0.3s"} ease-out;\n    `;c.style.cssText=l+u;const m=document.createElement("div");m.className="banner-message",m.textContent="This site may require additional steps.  Please see the 'Info for this site' button.",m.style.cssText="\n        color: #155e75;\n        flex: 1;\n        margin-right: 15px;\n    ";const g=document.createElement("div");g.className="banner-buttons",g.style.cssText="\n        display: flex;\n        gap: 10px;\n        align-items: center;\n    ";const h=document.createElement("button");h.textContent=o,h.setAttribute("aria-label",`Get help information for ${e}`),h.style.cssText=`\n        background-color: #0891b2;\n        color: #ffffff;\n        border: none;\n        padding: 8px 16px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: ${s.fontSize||"14px"};\n        font-weight: 500;\n        transition: all 0.2s ease;\n    `,h.addEventListener("mouseenter",(()=>{h.style.backgroundColor="#0e7490",h.style.transform="translateY(-1px)"})),h.addEventListener("mouseleave",(()=>{h.style.backgroundColor="#0891b2",h.style.transform=""})),h.addEventListener("focus",(()=>{h.style.outline="2px solid #0e7490",h.style.outlineOffset="2px"})),h.addEventListener("blur",(()=>{h.style.outline="",h.style.outlineOffset=""})),h.addEventListener("click",(()=>{window.open(t,"_blank")}));const f=document.createElement("button");f.innerHTML="&times;",f.setAttribute("aria-label","Close this notification"),f.style.cssText="\n        background: transparent;\n        border: none;\n        font-size: 20px;\n        font-weight: bold;\n        color: #155e75;\n        cursor: pointer;\n        padding: 0 0 0 10px;\n        line-height: 1;\n        width: 24px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: all 0.2s ease;\n    ",f.addEventListener("mouseenter",(()=>{f.style.backgroundColor="#cffafe",f.style.transform="scale(1.1)"})),f.addEventListener("mouseleave",(()=>{f.style.backgroundColor="transparent",f.style.transform=""})),f.addEventListener("focus",(()=>{f.style.outline="2px solid #0e7490",f.style.outlineOffset="2px"})),f.addEventListener("blur",(()=>{f.style.outline="",f.style.outlineOffset=""})),f.addEventListener("click",p),c.addEventListener("keydown",(e=>{"Escape"===e.key&&p()})),g.appendChild(h),g.appendChild(f),c.appendChild(m),c.appendChild(g),document.body.insertBefore(c,document.body.firstChild),i||(c.offsetHeight,c.style.transform="translateY(0)"),d(c.offsetHeight),setTimeout((()=>{h.focus()}),i?0:100)}(t.originalDomain,r,c)}}catch(e){console.error("[init] Error checking for EZProxy exception URL:",e)}chrome.storage.onChanged.addListener(((n,t)=>{if("local"===t&&n.dismissedDomains){const n=document.getElementById(e);n&&(n.remove(),u());!async function(e){if(console.log("[checkAndShowBanner] Starting check for URL:",e),!e||"string"!=typeof e)return void console.error("[checkAndShowBanner] Invalid URL provided:",e);try{console.log("[checkAndShowBanner] Step 1: Loading configuration...");const n=await a().catch((e=>{throw console.error("[checkAndShowBanner] Failed to load config:",e),new Error("Failed to load extension configuration")}));if(!n)return void console.error("[checkAndShowBanner] No configuration loaded");console.log("[checkAndShowBanner] Config loaded:",{institutionName:n.institutionName,ezproxyBaseUrl:n.ezproxyBaseUrl?"***":"Not set",hasAccessIndicators:Array.isArray(n.accessIndicators)?n.accessIndicators.length:0}),console.log("[checkAndShowBanner] Step 2: Loading domain list...");const t=await async function(){try{console.log("Fetching domain list...");const e=chrome.runtime.getURL("domain-list.json");console.log("Domain list URL:",e);const n=await fetch(e);if(!n.ok)throw new Error(`Failed to fetch domain list: ${n.status} ${n.statusText}`);const t=n.headers.get("content-type");t&&t.includes("application/json")||console.warn("Unexpected content type:",t);const o=await n.json();return console.log("Domain list loaded successfully, entries:",o.length),Array.isArray(o)?o:[]}catch(e){console.error("Error loading domain list:",e);try{const e=(await chrome.storage.local.get("ezproxy-domain-list-backup"))["ezproxy-domain-list-backup"];return console.log("Using backup domain list from storage:",e?e.length:0,"entries"),Array.isArray(e)?e:[]}catch(e){return console.error("Failed to load backup domain list:",e),[]}}}().catch((e=>{throw console.error("[checkAndShowBanner] Failed to load domain list:",e),new Error("Failed to load domain list")}));let o;console.log(`[checkAndShowBanner] Domain list loaded with ${t.length} entries`),console.log("[checkAndShowBanner] Step 3: Parsing URL...");try{const n=new URL(e);if(o=n.hostname,console.log("[checkAndShowBanner] Extracted domain:",o),/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(o))return void console.log("[checkAndShowBanner] IP address detected, skipping banner check")}catch(n){return void console.error("[checkAndShowBanner] Invalid URL:",e,"Error:",n)}console.log("[checkAndShowBanner] Step 4: Checking domain against domain list...");const s=t.find((e=>{const n=o===e,t=o.endsWith("."+e);return console.log(`[checkAndShowBanner] Checking ${e}: exact=${n}, subdomain=${t}`),n||t}));if(!s){console.log("[checkAndShowBanner] Domain not in list, updating icon to normal state");try{const[e]=await chrome.runtime.sendMessage({action:"getTab"});null!=e&&e.id&&await chrome.runtime.sendMessage({action:"updateIcon",tabId:e.id,isDismissed:!1})}catch(e){console.error("[checkAndShowBanner] Error updating icon for non-library domain:",e)}return}console.log("[checkAndShowBanner] Matched domain in list:",s),console.log("[checkAndShowBanner] Step 5: Checking if domain is dismissed...");if(await l(s).catch((e=>(console.error("[checkAndShowBanner] Error checking if domain is dismissed:",e),!1)))){console.log("[checkAndShowBanner] Domain is dismissed, updating icon to dismissed state");try{const[e]=await chrome.runtime.sendMessage({action:"getTab"});null!=e&&e.id&&await chrome.runtime.sendMessage({action:"updateIcon",tabId:e.id,isDismissed:!0})}catch(e){console.error("[checkAndShowBanner] Error updating icon for dismissed domain:",e)}return}console.log("[checkAndShowBanner] Step 6: Checking for institutional access...");try{if(c(n))return void console.log("[checkAndShowBanner] User has institutional access, skipping EZProxy notification");console.log("[checkAndShowBanner] No institutional access detected, proceeding with banner check")}catch(e){console.error("[checkAndShowBanner] Error checking institutional access:",e)}console.log("[checkAndShowBanner] Step 7: Verifying domain is still not dismissed...");if(await l(s).catch((()=>!1)))return void console.log("[checkAndShowBanner] Domain was dismissed during processing, aborting");if(console.log("[checkAndShowBanner] Step 8: Preparing EZProxy URL..."),!n.ezproxyBaseUrl)return void console.error("[checkAndShowBanner] No EZProxy base URL configured");let i=n.ezproxyBaseUrl.trim();i.endsWith("/")||(i=`${i}/`);let r=e;const d=r.match(/^https?:\/\/(.*)/i);d&&(r=d[1]);const u=Array.isArray(n.urlExceptions)?n.urlExceptions.find((e=>s.includes(e))):null;let g,p,f,y;if(!!u){const e=n.libraryHelpUrl||"https://library.example.edu/ask",t=h(s);g=`${e}${e.includes("?")?"&":"?"}q=${t}`,p=`${u} requires special access and cannot be accessed via standard EZProxy. Please visit your library's help page for assistance.`,f="How to Access",y="Learn how to access this resource through your library",console.log(`[checkAndShowBanner] Domain ${s} is an exception (${u}). Using help URL:`,g),sessionStorage.setItem("ezproxy-exception-domain","true"),sessionStorage.setItem("ezproxy-exception-button-text",f),sessionStorage.setItem("ezproxy-exception-button-aria",y)}else g=`${i}${r}`,p=`This resource is available through ${n.institutionName||"your library"}. Access the full content via EZProxy.`,console.log("[checkAndShowBanner] Created standard EZProxy URL:",g);console.log("[checkAndShowBanner] Step 9: Creating banner...");try{await m(p,g,s),console.log("[checkAndShowBanner] Banner creation completed successfully")}catch(e){throw console.error("[checkAndShowBanner] Error creating banner:",e),e}}catch(e){console.error("[checkAndShowBanner] Unhandled error:",e);try{const n=document.createElement("div");n.style.position="fixed",n.style.top="10px",n.style.right="10px",n.style.padding="10px",n.style.backgroundColor="#ffebee",n.style.border="1px solid #ef9a9a",n.style.borderRadius="4px",n.style.zIndex="100000",n.style.maxWidth="300px",n.style.fontFamily="Arial, sans-serif",n.style.fontSize="14px",n.innerHTML=`\n                <div style="font-weight: bold; margin-bottom: 5px;">EZProxy Extension Error</div>\n                <div>${e.message||"An unknown error occurred"}</div>\n                <div style="margin-top: 5px; font-size: 12px; color: #666;">\n                    Check console for details\n                </div>\n            `,document.body.appendChild(n),setTimeout((()=>{document.body.contains(n)&&n.remove()}),1e4)}catch(e){console.error("Could not display error banner:",e)}}}(window.location.href)}})),s=!0}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f(),chrome.runtime.onMessage.addListener(((e,n,t)=>{if("DOMAIN_MATCH"===e.type)return console.log("[onMessage] Received DOMAIN_MATCH message for:",e.domain),t({received:!0}),a().then((n=>{const t=n;return l(e.domain).then((e=>{if(e)throw console.log("[onMessage] Domain was previously dismissed, skipping notification"),new Error("DOMAIN_DISMISSED");return t}))})).then((e=>c(e).then((n=>{if(n)throw console.log("[onMessage] User has institutional access, skipping EZProxy notification"),new Error("HAS_INSTITUTIONAL_ACCESS");return e})).catch((n=>{if("HAS_INSTITUTIONAL_ACCESS"===n.message)throw n;return console.warn("[onMessage] Error checking institutional access, proceeding with banner:",n),e})))).then((n=>async function(){try{return!0===(await chrome.storage.local.get(o))[o]}catch(e){return console.error("Error checking auto-redirect setting:",e),!1}}().then((t=>{if(t)throw console.log("[onMessage] Auto-redirect enabled, redirecting to EZProxy"),window.location.href=e.ezproxyUrl,new Error("AUTO_REDIRECTED");return n})))).then((n=>{console.log("[onMessage] Showing banner for:",e.domain),m(e.bannerMessage||`This resource is available through ${n.institutionLibraryName||"your library"}. Access the full content via EZProxy.`,e.ezproxyUrl,e.domain)})).catch((e=>{["DOMAIN_DISMISSED","HAS_INSTITUTIONAL_ACCESS","AUTO_REDIRECTED"].includes(e.message)||console.error("[onMessage] Error processing domain match:",e)})),!0}));
//# sourceMappingURL=content.bundle.js.map