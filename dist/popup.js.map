{"version":3,"file":"popup.js","mappings":"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","sources":["webpack://ezproxy-extension/./popup.js"],"sourcesContent":["// Constants\nconst STORAGE_KEYS = {\n    DISMISSED_DOMAINS: 'ezproxy-dismissed-domains',\n    AUTO_REDIRECT: 'ezproxy-auto-redirect'\n};\n\n// Get DOM elements\nconst statusDiv = document.getElementById('status');\nconst accessButton = document.getElementById('accessButton');\nconst resetButton = document.getElementById('resetDismissed');\n\n// Check the current tab's status when popup opens\ndocument.addEventListener('DOMContentLoaded', async () => {\n    try {\n        // Set initial status\n        updateStatus('Checking current page...', false);\n        \n        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });\n        console.log('Current tab:', tab);\n        \n        if (!tab || !tab.url) {\n            console.error('No tab or URL found');\n            updateStatus('Could not access current tab', false);\n            return;\n        }\n        \n        console.log('Checking URL:', tab.url);\n        \n        // Check if current URL is in the domain list\n        const domainList = await getDomainList();\n        console.log('Domain list loaded, length:', domainList.length);\n        \n        if (!domainList || domainList.length === 0) {\n            console.error('Domain list is empty or failed to load');\n            updateStatus('Domain list could not be loaded', false);\n            return;\n        }\n        \n        const currentUrl = new URL(tab.url);\n        console.log('Current hostname:', currentUrl.hostname);\n        \n        // Load config for EZProxy base and help URL\n        const config = await (await fetch(chrome.runtime.getURL('config.json'))).json();\n        const ezproxyBaseUrl = config.ezproxyBaseUrl;\n        const libraryHelpUrl = config.libraryHelpUrl;\n        const secondaryHelpButtonText = config.secondaryHelpButtonText || 'Info for this site';\n\n        // Utility to extract the base domain (e.g., chronicle.com) from a proxied hostname (e.g., www-chronicle-com.ezproxy.library.wwu.edu)\n        function getBaseDomainFromProxied(hostname, ezproxyBaseUrl) {\n            // Remove the ezproxy part\n            const proxiedPart = hostname.replace('.' + ezproxyBaseUrl, '');\n            // Convert dashes to dots\n            const original = proxiedPart.replace(/-/g, '.');\n            // Return last two parts (base domain)\n            const parts = original.split('.');\n            if (parts.length <= 2) return original;\n            return parts.slice(-2).join('.');\n        }\n\n        // Detect if current page is already proxied\n        if (currentUrl.hostname.includes(ezproxyBaseUrl)) {\n            updateStatus('You are already on a proxied page.', true);\n            accessButton.disabled = false;\n            accessButton.textContent = secondaryHelpButtonText;\n            const baseDomain = getBaseDomainFromProxied(currentUrl.hostname, ezproxyBaseUrl);\n            let helpUrl = libraryHelpUrl;\n            if (helpUrl) {\n                helpUrl += (helpUrl.includes('?') ? '&' : '?') + 'q=' + encodeURIComponent(baseDomain);\n            }\n            accessButton.onclick = () => {\n                chrome.tabs.create({ url: helpUrl });\n                window.close();\n            };\n            return;\n        }\n        \n        // Check if domain matches any in the list\n        const isDomainInList = domainList.some(domain => {\n            const matches = currentUrl.hostname.endsWith(domain) || currentUrl.hostname === domain;\n            if (matches) console.log('Match found with domain:', domain);\n            return matches;\n        });\n        \n        console.log('Is domain in list:', isDomainInList);\n        \n        if (!isDomainInList) {\n            updateStatus('Current page is not a known library resource', false);\n            return;\n        }\n        \n        // Check if domain is dismissed\n        const result = await chrome.storage.local.get(STORAGE_KEYS.DISMISSED_DOMAINS);\n        const dismissedDomains = result[STORAGE_KEYS.DISMISSED_DOMAINS] || [];\n        console.log('Checking dismissed domains:', dismissedDomains);\n        \n        // Find the specific dismissed domain that matches the current hostname\n        const matchingDismissedDomain = dismissedDomains.find(d => \n            currentUrl.hostname.endsWith(d) || currentUrl.hostname === d\n        );\n        console.log('Matching dismissed domain:', matchingDismissedDomain);\n        \n        const isDismissed = !!matchingDismissedDomain;\n        \n        if (isDismissed) {\n            updateStatus('Banner is currently dismissed for this domain', false);\n            accessButton.disabled = false;\n            accessButton.textContent = 'Show Banner Again';\n            accessButton.onclick = async () => {\n                console.log('Show Banner Again button clicked for domain:', currentUrl.hostname);\n                // Store the matching domain for undismissing\n                const domainToUndismiss = matchingDismissedDomain || currentUrl.hostname;\n                console.log('Will undismiss domain:', domainToUndismiss);\n                await undismissDomain(domainToUndismiss);\n            };\n        } else {\n            updateStatus('This page is a known library resource', true);\n            accessButton.disabled = false;\n            accessButton.onclick = () => redirectToEZProxy(tab.url);\n        }\n    } catch (error) {\n        console.error('Error in popup:', error);\n        updateStatus('Error checking current page', false);\n    }\n});\n\n// Handle reset dismissed domains button\nresetButton.addEventListener('click', async () => {\n    console.log('Reset button clicked');\n    \n    // Show confirmation dialog\n    const confirmed = confirm('Are you sure you want to reset all dismissed domains? This will re-enable the banner for all previously dismissed domains.');\n    \n    if (!confirmed) {\n        console.log('Reset cancelled by user');\n        return;\n    }\n    \n    try {\n        console.log('Starting reset process...');\n        \n        // Save the original button text\n        // Removed unused variable 'originalButtonText' to fix ESLint error\n        \n        // Clear the dismissed domains\n        console.log('Clearing dismissed domains from storage...');\n        await chrome.storage.local.remove(STORAGE_KEYS.DISMISSED_DOMAINS);\n        console.log('Dismissed domains cleared');\n        \n        // Verify the domains were cleared\n        const result = await chrome.storage.local.get(STORAGE_KEYS.DISMISSED_DOMAINS);\n        console.log('Storage after clear:', result);\n        \n        // Update the status\n        updateStatus('Successfully reset all dismissed domains. Reloading page...', true);\n        \n        // Get the current active tab first\n        const [currentTab] = await chrome.tabs.query({ active: true, currentWindow: true });\n        console.log('Current active tab:', currentTab);\n        \n        if (currentTab && currentTab.id) {\n            // Reset the icon for the current tab first\n            console.log(`Updating icon for current tab ${currentTab.id}`);\n            try {\n                await chrome.runtime.sendMessage({\n                    action: 'updateIcon',\n                    tabId: currentTab.id,\n                    isDismissed: false\n                });\n                console.log('Icon updated for current tab');\n            } catch (error) {\n                console.error('Error updating icon for current tab:', error);\n            }\n            \n            // Reload the current tab to show the banner\n            console.log('Reloading current tab...');\n            await chrome.tabs.reload(currentTab.id);\n            console.log('Current tab reloaded');\n        }\n        \n        // Reset icons for all other tabs in the background\n        console.log('Updating icons for all tabs...');\n        const allTabs = await chrome.tabs.query({});\n        for (const tab of allTabs) {\n            if (tab.id && tab.id !== currentTab?.id) {\n                try {\n                    await chrome.runtime.sendMessage({\n                        action: 'updateIcon',\n                        tabId: tab.id,\n                        isDismissed: false\n                    });\n                    console.log(`Updated icon for tab ${tab.id}`);\n                } catch (error) {\n                    console.error(`Error updating icon for tab ${tab.id}:`, error);\n                }\n            }\n        }\n        \n        console.log('Reset process completed');\n        \n        // Close the popup after a short delay\n        setTimeout(() => {\n            console.log('Closing popup...');\n            window.close();\n        }, 1000);\n        \n    } catch (error) {\n        console.error('Error in reset process:', error);\n        updateStatus('Error: ' + (error.message || 'Failed to reset domains'), false);\n        resetButton.disabled = false;\n        resetButton.textContent = 'Try Again';\n    }\n});\n\n// Helper function to update the status display\nfunction updateStatus(message, isActive) {\n    console.log(`Updating status: ${message}, isActive: ${isActive}`);\n    \n    // Make sure the status div exists\n    if (!statusDiv) {\n        console.error('Status div not found in DOM');\n        return;\n    }\n    \n    // Update the text content\n    statusDiv.textContent = message;\n    \n    // Update the class\n    statusDiv.className = `status ${isActive ? 'active' : 'inactive'}`;\n    \n    // Update button state if it exists\n    if (accessButton) {\n        accessButton.disabled = !isActive && message !== 'Banner is currently dismissed for this domain';\n    } else {\n        console.error('Access button not found in DOM');\n    }\n}\n\n// Helper function to get domain list\nasync function getDomainList() {\n    try {\n        console.log('Fetching domain list...');\n        const url = chrome.runtime.getURL('domain-list.json');\n        console.log('Domain list URL:', url);\n        \n        const response = await fetch(url);\n        \n        if (!response.ok) {\n            throw new Error(`Failed to fetch domain list: ${response.status} ${response.statusText}`);\n        }\n        \n        const contentType = response.headers.get('content-type');\n        if (!contentType || !contentType.includes('application/json')) {\n            console.warn('Unexpected content type:', contentType);\n        }\n        \n        const data = await response.json();\n        console.log('Domain list loaded successfully, entries:', data.length);\n        return Array.isArray(data) ? data : [];\n    } catch (error) {\n        console.error('Error loading domain list:', error);\n        // Try to load a backup list from storage\n        try {\n            const result = await chrome.storage.local.get('ezproxy-domain-list-backup');\n            const backupList = result['ezproxy-domain-list-backup'];\n            console.log('Using backup domain list from storage:', backupList ? backupList.length : 0, 'entries');\n            return Array.isArray(backupList) ? backupList : [];\n        } catch (storageError) {\n            console.error('Failed to load backup domain list:', storageError);\n            return [];\n        }\n    }\n}\n\n// Helper function to redirect to EZProxy\nasync function redirectToEZProxy(url) {\n    try {\n        const config = await (await fetch(chrome.runtime.getURL('config.json'))).json();\n        \n        // Ensure the target URL is properly formatted\n        let targetUrl = url;\n        if (targetUrl.startsWith('http://')) {\n            targetUrl = targetUrl.substring(7); // Remove http://\n        } else if (targetUrl.startsWith('https://')) {\n            targetUrl = targetUrl.substring(8); // Remove https://\n        }\n        \n        // Ensure the EZProxy base URL ends with a forward slash\n        let ezproxyBase = config.ezproxyBaseUrl;\n        if (!ezproxyBase.endsWith('/')) {\n            ezproxyBase = `${ezproxyBase}/`;\n        }\n        \n        const ezproxyUrl = `${ezproxyBase}${targetUrl}`;\n        console.log('Redirecting to EZProxy URL:', ezproxyUrl);\n        \n        await chrome.tabs.update({ url: ezproxyUrl });\n        window.close();\n    } catch (error) {\n        console.error('Error redirecting to EZProxy:', error);\n        updateStatus('Error redirecting to EZProxy', false);\n    }\n}\n\n// Helper function to undismiss a domain\nasync function undismissDomain(domain) {\n    try {\n        console.log('Undismissing domain:', domain);\n        \n        // Get the current list of dismissed domains\n        const result = await chrome.storage.local.get(STORAGE_KEYS.DISMISSED_DOMAINS);\n        const dismissedDomains = result[STORAGE_KEYS.DISMISSED_DOMAINS] || [];\n        console.log('Current dismissed domains:', dismissedDomains);\n        \n        if (dismissedDomains.length === 0) {\n            console.warn('No dismissed domains found in storage');\n            updateStatus('No dismissed domains found', false);\n            return;\n        }\n        \n        // For debugging, log each domain in the list and check if it matches\n        console.log('Checking each dismissed domain against:', domain);\n        let foundMatches = [];\n        \n        dismissedDomains.forEach(d => {\n            const endsWith = domain.endsWith(d);\n            const exactMatch = domain === d;\n            console.log(`Domain: ${d}, endsWith: ${endsWith}, exactMatch: ${exactMatch}`);\n            \n            if (exactMatch || endsWith) {\n                foundMatches.push(d);\n            }\n        });\n        \n        console.log('Found matching dismissed domains:', foundMatches);\n        \n        if (foundMatches.length === 0) {\n            console.warn('Could not find any matching dismissed domains for:', domain);\n            updateStatus('No matching domains found in dismissed list', false);\n            return;\n        }\n        \n        // Remove all matching domains from the dismissed list\n        const updatedDomains = dismissedDomains.filter(d => !foundMatches.includes(d));\n        console.log('Updated dismissed domains:', updatedDomains);\n        \n        // Save the updated list\n        await chrome.storage.local.set({ [STORAGE_KEYS.DISMISSED_DOMAINS]: updatedDomains });\n        console.log('Saved updated dismissed domains list');\n        \n        // Update the extension icon to show normal state\n        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });\n        console.log('Current tab:', tab);\n        \n        if (tab && tab.id) {\n            console.log('Sending updateIcon message for tab:', tab.id);\n            try {\n                const response = await chrome.runtime.sendMessage({\n                    action: 'updateIcon',\n                    tabId: tab.id,\n                    isDismissed: false\n                });\n                console.log('Response from updateIcon message:', response);\n            } catch (msgError) {\n                console.error('Error sending updateIcon message:', msgError);\n            }\n            \n            // Update the UI\n            updateStatus('Banner will show again on next visit', true);\n            accessButton.disabled = true;\n            accessButton.textContent = 'Access via EZProxy';\n            \n            // Reload the current tab to show the banner\n            console.log('Reloading tab:', tab.id);\n            await chrome.tabs.reload(tab.id);\n            window.close();\n        }\n    } catch (error) {\n        console.error('Error undismissing domain:', error);\n        updateStatus('Error updating settings', false);\n    }\n}\n"],"names":["STORAGE_KEYS","statusDiv","document","getElementById","accessButton","resetButton","updateStatus","message","isActive","textContent","className","disabled","addEventListener","async","tab","chrome","tabs","query","active","currentWindow","url","domainList","runtime","getURL","response","fetch","ok","Error","status","statusText","contentType","headers","get","includes","data","json","Array","isArray","error","backupList","storage","local","storageError","getDomainList","length","currentUrl","URL","config","ezproxyBaseUrl","libraryHelpUrl","secondaryHelpButtonText","hostname","baseDomain","original","replace","parts","split","slice","join","getBaseDomainFromProxied","helpUrl","encodeURIComponent","onclick","create","window","close","some","domain","matches","endsWith","result","matchingDismissedDomain","find","d","domainToUndismiss","dismissedDomains","foundMatches","forEach","push","updatedDomains","filter","set","id","sendMessage","action","tabId","isDismissed","msgError","reload","undismissDomain","targetUrl","startsWith","substring","ezproxyBase","ezproxyUrl","update","redirectToEZProxy","confirm","remove","currentTab","allTabs","setTimeout"],"sourceRoot":""}